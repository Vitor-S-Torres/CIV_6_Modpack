--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
-- INCLUDES
--==========================================================================================================================

--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
print("Mexico Great Artist Burst from Great Generals Expending script loaded")
--==========================================================================================================================
-- Variables
--==========================================================================================================================

local iProperty = "Leu_Panteon_GPBonus"
local iImprovement = "IMPROVEMENT_LEU_PANTEON"
-- Values
local iTileRange = 2






--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
-- UTILITY FUNCTIONS
--==========================================================================================================================
-- UTILS
----------------------------------------------------------------------------------------------------------------------------


--GreatPersonPositionSaver

function Leu_GreatPersonAddedToMap(playerId, unitId, unitX, unitY)
	local player = Players[playerId]
	local unit = player:GetUnits():FindID(unitId);
	if unit then
	if unit:GetGreatPerson() then 
		individual = unit:GetGreatPerson():GetIndividual()
		Game:SetProperty(individual .. "X", unitX)
		Game:SetProperty(individual .. "Y", unitY)
	end
	end
end
function Leu_GreatPersonMoved(playerId, unitId, unitX, unitY, visible, stateChange)
	local player = Players[playerId]
	local unit = player:GetUnits():FindID(unitId);
	if unit then
	if unit:GetGreatPerson() then 
		individual = unit:GetGreatPerson():GetIndividual()
		Game:SetProperty(individual .. "X", unitX)
		Game:SetProperty(individual .. "Y", unitY)
	end
	end
end
Events.UnitAddedToMap.Add(Leu_GreatPersonAddedToMap);
Events.UnitMoved.Add(Leu_GreatPersonMoved);
--==========================================================================================================================
-- CORE FUNCTIONS
--==========================================================================================================================

function Leu_OnGreatPersonActivated (unitOwnerID, unitID, greatPersonClassID, individualID)
	local player = Players[unitOwnerID]
	--
	if (player ~= nil) then
		local unit = player:GetUnits():FindID(unitID);
		if (unit ~= nil) then
			local iGPUnitName =  GameInfo.GreatPersonClasses[greatPersonClassID].UnitType
			print(iGPUnitName .. " was used")
			iGreatX = Game:GetProperty(individualID .. "X")
			iGreatY = Game:GetProperty(individualID .. "Y")
			--if iGreatX == unit:GetX() then
			--	print("Great Person is not fully expended")
			--	return
			--else
			--	print("Great Person is fully expended get hype")
				
				-- Let's check the plots
				for dx = (iTileRange*-1), iTileRange do
					for dy = (iTileRange*-1), iTileRange do
						local iPlot = Map.GetPlotXYWithRangeCheck(iGreatX, iGreatY, dx, dy, iTileRange);
						--print("Checking a plot")
						if iPlot ~= nil then
							--print("Checking a not nil plot")
							if iPlot:GetImprovementType() == (GameInfo.Improvements["" .. iImprovement .. ""].Index) then
								print("found a plot with the required improvement!")
								local currentP = iPlot:GetProperty(iProperty)
								if currentP == nil then currentP = 0 end
								iPlot:SetProperty(iProperty, currentP + 1)
								if iPlot:GetProperty(iProperty) % 2 == 0 then
									if iPlot:GetProperty(iProperty) < 21 then
										Game.AddWorldViewText(unitOwnerID, "[COLOR_FLOAT_CULTURE]+1[ICON_CULTURE][ENDCOLOR]", iPlot:GetX(), iPlot:GetY(), 1)
									end
								end
							end
						end
					end
				end
			--end
		end
	end
end

function FlushPropertyImprovement(iX, iY, iOwner)
	local RemovalPlot = Map.GetPlot(iX, iY);
	RemovalPlot:SetProperty(iProperty, 0)
end

Events.UnitGreatPersonActivated.Add(Leu_OnGreatPersonActivated);
Events.ImprovementRemovedFromMap.Add(FlushPropertyImprovement);
--==========================================================================================================================
--==========================================================================================================================